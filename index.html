<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>My Calendar</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÖ</text></svg>" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Caveat:wght@400;600;700&family=Orbitron:wght@700;900&family=Rajdhani:wght@400;600&family=DM+Serif+Display&family=Nunito:wght@400;600;700&family=Libre+Baskerville:wght@400;700&family=Source+Sans+3:wght@400;600&family=Abril+Fatface&family=Quicksand:wght@400;600;700&family=Cormorant+Garamond:wght@600;700&family=Outfit:wght@400;600&family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   THEME DEFINITIONS
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
[data-theme="0"]{--bg:linear-gradient(145deg,#fdf6e3,#f5e6c8,#ede0c8);--card-bg:#fffdf7;--border:#d4c5a9;--h-font:'Playfair Display',serif;--b-font:'Caveat',cursive;--txt:#2d3436;--txt2:#636e72;--accent:#d63031;--goal:#00b894;--note:#00b894;--diary:#6c5ce7;--today-bg:#d63031;--wknd:#d63031;--btn:linear-gradient(135deg,#00b894,#00cec9);--btn-sh:rgba(0,184,148,.4);--input-bg:#fff9ee;--pattern:none;--shadow:0 8px 40px rgba(0,0,0,.08);--cell-hover:rgba(214,48,49,.05);--pulse:rgba(214,48,49,.3)}
[data-theme="1"]{--bg:linear-gradient(145deg,#0a0a1a,#1a1a3e,#0d0d2b);--card-bg:#12122e;--border:#2a2a5e;--h-font:'Orbitron',sans-serif;--b-font:'Rajdhani',sans-serif;--txt:#e0e0ff;--txt2:#8888bb;--accent:#ff2d95;--goal:#00f5d4;--note:#00f5d4;--diary:#b388ff;--today-bg:#ff2d95;--wknd:#ff6b9d;--btn:linear-gradient(135deg,#ff2d95,#ff6b6b);--btn-sh:rgba(255,45,149,.4);--input-bg:#1a1a3e;--pattern:radial-gradient(circle at 20% 80%,rgba(255,45,149,.06),transparent 50%),radial-gradient(circle at 80% 20%,rgba(0,245,212,.04),transparent 50%);--shadow:0 8px 40px rgba(255,45,149,.1),0 0 80px rgba(0,0,0,.5);--cell-hover:rgba(255,45,149,.08);--pulse:rgba(255,45,149,.3)}
[data-theme="2"]{--bg:linear-gradient(145deg,#f0f7ee,#dcedc8,#c5e1a5);--card-bg:#f9fdf6;--border:#a5d6a7;--h-font:'DM Serif Display',serif;--b-font:'Nunito',sans-serif;--txt:#2e4a2e;--txt2:#5a7a5a;--accent:#2e7d32;--goal:#ff8f00;--note:#2e7d32;--diary:#5d4037;--today-bg:#2e7d32;--wknd:#558b2f;--btn:linear-gradient(135deg,#43a047,#66bb6a);--btn-sh:rgba(67,160,71,.4);--input-bg:#f0f7ee;--pattern:none;--shadow:0 8px 40px rgba(46,125,50,.08);--cell-hover:rgba(46,125,50,.06);--pulse:rgba(46,125,50,.3)}
[data-theme="3"]{--bg:linear-gradient(145deg,#e3f2fd,#bbdefb,#90caf9);--card-bg:#f5faff;--border:#90caf9;--h-font:'Libre Baskerville',serif;--b-font:'Source Sans 3',sans-serif;--txt:#1a3a5c;--txt2:#5a8ab5;--accent:#0277bd;--goal:#e65100;--note:#0277bd;--diary:#4527a0;--today-bg:#0277bd;--wknd:#0288d1;--btn:linear-gradient(135deg,#0288d1,#03a9f4);--btn-sh:rgba(2,136,209,.4);--input-bg:#e8f4fd;--pattern:none;--shadow:0 8px 40px rgba(2,119,189,.08);--cell-hover:rgba(2,119,189,.06);--pulse:rgba(2,119,189,.3)}
[data-theme="4"]{--bg:linear-gradient(145deg,#fff3e0,#ffe0b2,#ffcc80);--card-bg:#fffaf3;--border:#ffb74d;--h-font:'Abril Fatface',serif;--b-font:'Quicksand',sans-serif;--txt:#4e2a00;--txt2:#8d6e40;--accent:#e65100;--goal:#ad1457;--note:#e65100;--diary:#6a1b9a;--today-bg:#e65100;--wknd:#f4511e;--btn:linear-gradient(135deg,#e65100,#ff6d00);--btn-sh:rgba(230,81,0,.35);--input-bg:#fff8ee;--pattern:none;--shadow:0 8px 40px rgba(230,81,0,.08);--cell-hover:rgba(230,81,0,.06);--pulse:rgba(230,81,0,.3)}
[data-theme="5"]{--bg:linear-gradient(145deg,#f3e5f5,#e1bee7,#ce93d8);--card-bg:#faf5fc;--border:#ce93d8;--h-font:'Cormorant Garamond',serif;--b-font:'Outfit',sans-serif;--txt:#3a1a4a;--txt2:#7a5a8a;--accent:#7b1fa2;--goal:#00838f;--note:#7b1fa2;--diary:#c2185b;--today-bg:#7b1fa2;--wknd:#8e24aa;--btn:linear-gradient(135deg,#8e24aa,#ab47bc);--btn-sh:rgba(142,36,170,.4);--input-bg:#f3e5f5;--pattern:none;--shadow:0 8px 40px rgba(123,31,162,.08);--cell-hover:rgba(123,31,162,.06);--pulse:rgba(123,31,162,.3)}
[data-theme="6"]{--bg:linear-gradient(145deg,#1a1a1a,#2d2d2d,#1e1e1e);--card-bg:#252525;--border:#444;--h-font:'Bebas Neue',sans-serif;--b-font:'IBM Plex Mono',monospace;--txt:#e0e0e0;--txt2:#888;--accent:#ff6b35;--goal:#4ecdc4;--note:#4ecdc4;--diary:#ffd93d;--today-bg:#ff6b35;--wknd:#ff8a5c;--btn:linear-gradient(135deg,#ff6b35,#ff8a5c);--btn-sh:rgba(255,107,53,.4);--input-bg:#1e1e1e;--pattern:repeating-linear-gradient(0deg,transparent,transparent 49px,rgba(255,255,255,.02) 50px);--shadow:0 8px 40px rgba(0,0,0,.4);--cell-hover:rgba(255,107,53,.08);--pulse:rgba(255,107,53,.3)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   APP STYLES
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{min-height:100vh;background:var(--bg);font-family:var(--b-font);color:var(--txt);display:flex;flex-direction:column;align-items:center;padding:14px 10px 36px;transition:background .5s ease}
.hidden{display:none!important}
.pattern-overlay{position:fixed;inset:0;background:var(--pattern);pointer-events:none;z-index:0}

.top-bar{width:100%;max-width:840px;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;position:relative;z-index:20}
.top-bar-right{display:flex;align-items:center;gap:8px}

.btn-today{background:color-mix(in srgb,var(--accent) 10%,transparent);border:1.5px solid color-mix(in srgb,var(--accent) 28%,transparent);border-radius:20px;padding:5px 15px;font-size:13px;font-family:var(--b-font);cursor:pointer;color:var(--accent);font-weight:600;transition:transform .12s}
.btn-today:hover{transform:scale(1.05)}

.dd-wrap{position:relative}
.dd-btn{background:var(--card-bg);border:1.5px solid var(--border);border-radius:22px;padding:5px 12px;font-size:13px;font-family:var(--b-font);cursor:pointer;color:var(--txt);display:flex;align-items:center;gap:5px;box-shadow:0 2px 8px rgba(0,0,0,.08);transition:transform .12s;white-space:nowrap}
.dd-btn:hover{transform:scale(1.03)}
.dd-panel{position:absolute;top:115%;right:0;background:var(--card-bg);border:1.5px solid var(--border);border-radius:14px;padding:5px;min-width:200px;z-index:100;box-shadow:0 12px 40px rgba(0,0,0,.25)}
.dd-opt{display:flex;align-items:center;gap:7px;width:100%;padding:8px 12px;border:none;background:transparent;border-radius:9px;cursor:pointer;font-size:13px;font-family:var(--b-font);color:var(--txt);text-align:left;transition:background .1s}
.dd-opt:hover{background:rgba(128,128,128,.12)}
.dd-opt.active{background:rgba(128,128,128,.15)}
.dd-div{height:1px;background:var(--border);margin:3px 0}

.month-header{width:100%;max-width:840px;display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;z-index:1}
.nav-arrow{background:none;border:none;font-size:42px;cursor:pointer;color:var(--txt2);padding:0 12px;line-height:1;transition:color .15s,transform .12s}
.nav-arrow:hover{color:var(--accent);transform:scale(1.15)}
.month-title{text-align:center}
.month-title h1{font-size:clamp(36px,9vw,66px);font-family:var(--h-font);font-weight:900;color:var(--txt);letter-spacing:-1px;line-height:1.05}
[data-theme="6"] .month-title h1{letter-spacing:4px}
[data-theme="1"] .month-title h1{letter-spacing:2px}
.month-title p{font-size:clamp(15px,3.5vw,22px);color:var(--txt2);font-family:var(--h-font);font-weight:700}
[data-theme="6"] .month-title p{letter-spacing:5px}

.calendar-grid{width:100%;max-width:840px;background:var(--card-bg);border-radius:16px;border:2px solid var(--border);overflow:hidden;box-shadow:var(--shadow);z-index:1;position:relative;animation:slideIn .35s ease}
@keyframes slideIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

.day-headers{display:grid;grid-template-columns:repeat(7,1fr);border-bottom:2px solid var(--border)}
.day-hdr{text-align:center;padding:10px 0;font-size:clamp(11px,2.6vw,16px);font-weight:700;color:var(--txt);font-family:var(--h-font);border-right:1px solid color-mix(in srgb,var(--border) 30%,transparent)}
.day-hdr:last-child{border-right:none}
.day-hdr.wk{color:var(--wknd)}
[data-theme="6"] .day-hdr{letter-spacing:2px}
.cells{display:grid;grid-template-columns:repeat(7,1fr)}

.cell{min-height:clamp(64px,12vw,106px);padding:4px 5px;border-right:1px solid color-mix(in srgb,var(--border) 30%,transparent);border-bottom:1px solid color-mix(in srgb,var(--border) 30%,transparent);position:relative;overflow:hidden;cursor:pointer;transition:transform .12s,background .12s}
.cell:nth-child(7n){border-right:none}
.cell.lr{border-bottom:none}
.cell.cur:hover{transform:scale(1.03);z-index:2;background:var(--cell-hover)!important}
.cell.cur:active{transform:scale(.97)}
.cell.om{opacity:.22;cursor:default;pointer-events:none}
.cell.we{background:color-mix(in srgb,var(--wknd) 4%,transparent)}

.dnum{font-size:clamp(13px,3vw,22px);font-weight:700;font-family:var(--h-font);color:var(--txt);display:flex;align-items:center;justify-content:center;line-height:1;position:relative;z-index:3;width:fit-content}
[data-theme="6"] .dnum{letter-spacing:1px}
.cell.we .dnum{color:var(--wknd)}
.dnum.today{color:#fff!important;background:var(--today-bg);width:clamp(22px,5vw,32px);height:clamp(22px,5vw,32px);border-radius:50%;animation:pulse 2.5s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 var(--pulse)}50%{box-shadow:0 0 0 8px transparent}}

.xm{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);opacity:.75;pointer-events:none;z-index:1}
.gb{position:absolute;top:2px;right:3px;font-size:8px;background:var(--goal);color:#fff;border-radius:5px;padding:1px 5px;font-family:var(--b-font);font-weight:700;z-index:4;line-height:12px}
.np{font-size:clamp(8px,1.5vw,11px);color:var(--note);line-height:1.15;margin-top:1px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;z-index:3;font-weight:600}
.di{position:absolute;bottom:2px;right:3px;font-size:10px;z-index:3}

.stats{width:100%;max-width:840px;margin-top:10px;display:flex;flex-wrap:wrap;gap:18px;justify-content:center;font-size:14px;color:var(--txt2);z-index:1}
.hint{margin-top:5px;font-size:12px;color:var(--txt2);opacity:.6;z-index:1}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--txt,#333);color:var(--card-bg,#fff);padding:7px 18px;border-radius:20px;font-size:13px;z-index:50}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(6px);animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--card-bg);border-radius:18px;padding:28px 26px 22px;width:92%;max-width:450px;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow);font-family:var(--b-font);border:2px solid var(--border);position:relative;animation:mIn .25s ease}
@keyframes mIn{from{opacity:0;transform:translateY(20px) scale(.96)}to{opacity:1;transform:translateY(0) scale(1)}}
.modal-x{position:absolute;top:10px;right:14px;background:none;border:none;font-size:24px;cursor:pointer;color:var(--txt2)}
.modal-x:hover{color:var(--accent)}
.modal h2{font-size:28px;color:var(--txt);font-family:var(--h-font);font-weight:900;margin-bottom:2px}
.modal>p{font-size:16px;color:var(--txt2);margin-bottom:18px}
.msec{margin-bottom:16px}
.cbl{display:flex;align-items:center;gap:10px;cursor:pointer;font-size:17px;color:var(--txt)}
.cbl input[type=checkbox]{width:18px;height:18px;accent-color:var(--accent)}
.cpk{display:flex;gap:6px;margin-top:8px;margin-left:28px}
.cdot{width:24px;height:24px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:transform .12s}
.cdot:hover{transform:scale(1.15)}
.cdot.act{border-color:var(--txt);transform:scale(1.25)}
.flbl{font-size:16px;display:block;margin-bottom:5px;color:var(--txt);font-weight:600}
.modal textarea{width:100%;padding:10px;border-radius:10px;border:1.5px solid var(--border);background:var(--input-bg);font-size:15px;font-family:var(--b-font);resize:vertical;outline:none;transition:border-color .15s}
.modal textarea:focus{border-color:var(--accent)}
#inp-note{color:var(--note)}
#inp-diary{color:var(--diary)}
.btn-save{width:100%;padding:11px 0;margin-top:6px;border-radius:12px;border:none;background:var(--btn);color:#fff;font-size:18px;font-family:var(--b-font);cursor:pointer;font-weight:700;box-shadow:0 4px 15px var(--btn-sh);transition:transform .12s}
.btn-save:hover{transform:scale(1.02)}
.btn-save:active{transform:scale(.98)}

::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-thumb{background:var(--border,#888);border-radius:3px}
@media(max-width:480px){body{padding:8px 4px 24px}.cell{min-height:58px;padding:3px}.modal{padding:20px 16px 16px}.top-bar-right{gap:4px}.dd-btn{padding:4px 8px;font-size:11px}}
</style>
</head>
<body>

<div class="pattern-overlay"></div>

<div class="top-bar">
  <button class="btn-today" onclick="goToday()">‚óè Today</button>
  <div class="top-bar-right">
    <div class="dd-wrap">
      <button class="dd-btn" onclick="toggleDD('theme-dd',event)"><span id="t-emoji"></span> <span id="t-name"></span> ‚ñæ</button>
      <div id="theme-dd" class="dd-panel hidden"></div>
    </div>
  </div>
</div>

<div class="month-header">
  <button class="nav-arrow" onclick="prevMonth()">‚Äπ</button>
  <div class="month-title"><h1 id="m-name"></h1><p id="y-label"></p></div>
  <button class="nav-arrow" onclick="nextMonth()">‚Ä∫</button>
</div>

<div class="calendar-grid" id="cal-grid">
  <div class="day-headers">
    <div class="day-hdr">Mon</div><div class="day-hdr">Tue</div><div class="day-hdr">Wed</div>
    <div class="day-hdr">Thu</div><div class="day-hdr">Fri</div><div class="day-hdr wk">Sat</div><div class="day-hdr wk">Sun</div>
  </div>
  <div class="cells" id="cells"></div>
</div>

<div class="stats" id="stats"></div>
<div class="hint">Theme changes daily ¬∑ pick one manually from the dropdown</div>

<div id="modal-ov" class="modal-overlay hidden" onclick="closeModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <button class="modal-x" onclick="closeModal()">‚úï</button>
    <h2 id="m-title"></h2>
    <p id="m-day"></p>
    <div class="msec">
      <label class="cbl"><input type="checkbox" id="chk-mark" onchange="toggleCP()"><span>‚úï Mark this day</span></label>
      <div class="cpk hidden" id="cpk"></div>
    </div>
    <div class="msec">
      <label class="cbl"><input type="checkbox" id="chk-goal"><span>‚≠ê Goal achieved</span></label>
    </div>
    <div class="msec">
      <label class="flbl">üìù Note</label>
      <textarea id="inp-note" rows="2" placeholder="Quick note..."></textarea>
    </div>
    <div class="msec">
      <label class="flbl">üìñ Personal Diary</label>
      <textarea id="inp-diary" rows="4" placeholder="Write your thoughts..."></textarea>
    </div>
    <button class="btn-save" onclick="saveModal()">Save Entry</button>
  </div>
</div>

<div id="toast" class="toast hidden">Loading...</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const sb = window.supabase.createClient(
  'https://wylxvmkcrexwfpjpbhyy.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5bHh2bWtjcmV4d2ZwanBiaHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzkxMDYsImV4cCI6MjA4NDIxNTEwNn0.6Bxo42hx4jwlJGWnfjiTpiDUsYfc1QLTN3YtrU1efak'
);
const UID = 'default-user';

const MO=['January','February','March','April','May','June','July','August','September','October','November','December'];
const DN=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const MC={red:'#d63031',pink:'#e84393',teal:'#00b894',cyan:'#00cec9',orange:'#e17055',purple:'#6c5ce7',yellow:'#fdcb6e'};
const TH=[{name:'Parchment Journal',emoji:'üìú'},{name:'Midnight Tokyo',emoji:'üåÉ'},{name:'Forest Morning',emoji:'üåø'},{name:'Ocean Breeze',emoji:'üåä'},{name:'Sunset Amber',emoji:'üåÖ'},{name:'Lavender Dusk',emoji:'ü™ª'},{name:'Carbon Night',emoji:'üñ§'}];

let curYear=new Date().getFullYear(), curMonth=new Date().getMonth(), calData={}, modalKey=null, modalColor='red', manualTheme=-1;

function $(id){return document.getElementById(id)}

/* THEMES */
function autoTheme(){const n=new Date(),s=new Date(n.getFullYear(),0,0);return Math.floor((n-s)/864e5)%TH.length}
function activeTheme(){return manualTheme===-1?autoTheme():manualTheme}
function applyTheme(i){document.body.setAttribute('data-theme',i);$('t-emoji').textContent=TH[i].emoji;$('t-name').textContent=TH[i].name}

function buildThemeDD(){
  const dd=$('theme-dd');dd.innerHTML='';
  let b=document.createElement('button');b.className='dd-opt'+(manualTheme===-1?' active':'');b.textContent='üîÑ Auto (daily rotation)';
  b.onclick=()=>{manualTheme=-1;applyTheme(activeTheme());buildThemeDD();saveThemePref();closeAllDD()};dd.appendChild(b);
  dd.appendChild(Object.assign(document.createElement('div'),{className:'dd-div'}));
  TH.forEach((t,i)=>{let b=document.createElement('button');b.className='dd-opt'+(manualTheme===i?' active':'');b.textContent=t.emoji+' '+t.name;
  b.onclick=()=>{manualTheme=i;applyTheme(i);buildThemeDD();saveThemePref();closeAllDD()};dd.appendChild(b)});
}

async function saveThemePref(){await sb.from('calendar_app_preferences').upsert({user_id:UID,theme_pref:manualTheme},{onConflict:'user_id'})}
async function loadThemePref(){const{data}=await sb.from('calendar_app_preferences').select('theme_pref').eq('user_id',UID).single();manualTheme=data?.theme_pref??-1;buildThemeDD()}

/* DROPDOWN */
function toggleDD(id,e){e.stopPropagation();const el=$(id),was=el.classList.contains('hidden');closeAllDD();if(was)el.classList.remove('hidden')}
function closeAllDD(){document.querySelectorAll('.dd-panel').forEach(p=>p.classList.add('hidden'))}
document.addEventListener('click',closeAllDD);

/* CALENDAR */
function daysIn(y,m){return new Date(y,m+1,0).getDate()}
function firstDay(y,m){const d=new Date(y,m,1).getDay();return d===0?6:d-1}
function isToday(d){const t=new Date();return d===t.getDate()&&curMonth===t.getMonth()&&curYear===t.getFullYear()}
function dk(d){return`${curYear}-${String(curMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function xSvg(c){return`<svg class="xm" width="28" height="28" viewBox="0 0 40 40"><line x1="7" y1="7" x2="33" y2="33" stroke="${c}" stroke-width="4" stroke-linecap="round"/><line x1="33" y1="7" x2="7" y2="33" stroke="${c}" stroke-width="4" stroke-linecap="round"/></svg>`}

function renderCal(){
  const c=$('cells'),dim=daysIn(curYear,curMonth),fd=firstDay(curYear,curMonth),pDim=daysIn(curYear,curMonth===0?11:curMonth-1);
  const total=Math.ceil((fd+dim)/7)*7,rows=Math.ceil(total/7);
  $('m-name').textContent=MO[curMonth];$('y-label').textContent=curYear;
  let h='';
  for(let i=0;i<total;i++){
    let day,cur;
    if(i<fd){day=pDim-fd+i+1;cur=false}else if(i<fd+dim){day=i-fd+1;cur=true}else{day=i-fd-dim+1;cur=false}
    const we=i%7>=5,lr=Math.floor(i/7)===rows-1,key=cur?dk(day):null,dd=key?calData[key]:null;
    let cls='cell';if(cur)cls+=' cur';else cls+=' om';if(we&&cur)cls+=' we';if(lr)cls+=' lr';
    let dcls='dnum';if(isToday(day)&&cur)dcls+=' today';
    h+=`<div class="${cls}" ${cur?`data-k="${key}"`:''}><div class="${dcls}">${day}</div>`;
    if(cur&&dd){
      if(dd.marked)h+=xSvg(MC[dd.markColor]||MC.red);
      if(dd.isGoal)h+='<div class="gb">‚òÖ GOAL</div>';
      if(dd.note)h+=`<div class="np">${esc(dd.note)}</div>`;
      if(dd.diary)h+='<div class="di">üìñ</div>';
    }
    h+='</div>';
  }
  c.innerHTML=h;
  c.querySelectorAll('.cell.cur').forEach(el=>{el.addEventListener('click',()=>openModal(el.dataset.k,calData[el.dataset.k]))});
  const g=$('cal-grid');g.style.animation='none';g.offsetHeight;g.style.animation='slideIn .35s ease';
  updateStats();
}

function updateStats(){
  const ent=Object.values(calData),m=ent.filter(e=>e.marked).length,g=ent.filter(e=>e.isGoal).length,d=ent.filter(e=>e.diary).length;
  $('stats').innerHTML=m+g+d===0?'Tap any day to start tracking':`<span>‚úï ${m} marked</span><span>‚≠ê ${g} goals</span><span>üìñ ${d} diary entries</span>`;
}

/* NAVIGATION */
function prevMonth(){if(curMonth===0){curMonth=11;curYear--}else curMonth--;loadAndRender()}
function nextMonth(){if(curMonth===11){curMonth=0;curYear++}else curMonth++;loadAndRender()}
function goToday(){const t=new Date();curYear=t.getFullYear();curMonth=t.getMonth();loadAndRender()}
document.addEventListener('keydown',e=>{if(!$('modal-ov').classList.contains('hidden'))return;if(e.key==='ArrowLeft')prevMonth();if(e.key==='ArrowRight')nextMonth()});

/* LOAD DATA */
async function loadAndRender(){
  $('toast').classList.remove('hidden');
  const s=`${curYear}-${String(curMonth+1).padStart(2,'0')}-01`,last=daysIn(curYear,curMonth),e=`${curYear}-${String(curMonth+1).padStart(2,'0')}-${last}`;
  calData={};
  try{
    const{data:cal}=await sb.from('calendar_app_entries').select('entry_date,is_marked,mark_color,is_goal,note').eq('user_id',UID).gte('entry_date',s).lte('entry_date',e);
    const{data:diary}=await sb.from('calendar_app_diary').select('entry_date,content').eq('user_id',UID).gte('entry_date',s).lte('entry_date',e);
    (cal||[]).forEach(r=>{calData[r.entry_date]={marked:r.is_marked,markColor:r.mark_color||'red',isGoal:r.is_goal,note:r.note||'',diary:''}});
    (diary||[]).forEach(r=>{if(!calData[r.entry_date])calData[r.entry_date]={marked:false,markColor:'red',isGoal:false,note:'',diary:''};calData[r.entry_date].diary=r.content||''});
  }catch(err){console.error('Load:',err)}
  $('toast').classList.add('hidden');renderCal();
}

/* MODAL */
function buildCP(){const cpk=$('cpk');cpk.innerHTML='';Object.entries(MC).forEach(([n,c])=>{const b=document.createElement('button');b.className='cdot'+(modalColor===n?' act':'');b.style.background=c;b.onclick=()=>{modalColor=n;buildCP()};cpk.appendChild(b)})}
function toggleCP(){$('cpk').classList.toggle('hidden',!$('chk-mark').checked)}

function openModal(key,data){
  modalKey=key;const d=new Date(key+'T00:00:00');
  $('m-title').textContent=`${d.getDate()} ${MO[d.getMonth()]}`;$('m-day').textContent=`${DN[d.getDay()]}, ${d.getFullYear()}`;
  const dd=data||{};$('chk-mark').checked=dd.marked||false;$('chk-goal').checked=dd.isGoal||false;
  $('inp-note').value=dd.note||'';$('inp-diary').value=dd.diary||'';modalColor=dd.markColor||'red';
  buildCP();toggleCP();$('modal-ov').classList.remove('hidden');
}

function closeModal(){$('modal-ov').classList.add('hidden');modalKey=null}

async function saveModal(){
  if(!modalKey)return;
  const data={marked:$('chk-mark').checked,markColor:modalColor,isGoal:$('chk-goal').checked,note:$('inp-note').value.trim(),diary:$('inp-diary').value.trim()};
  const empty=!data.marked&&!data.isGoal&&!data.note&&!data.diary;
  if(empty)delete calData[modalKey];else calData[modalKey]=data;
  closeModal();renderCal();
  try{
    if(data.marked||data.isGoal||data.note){await sb.from('calendar_app_entries').upsert({user_id:UID,entry_date:modalKey,is_marked:data.marked,mark_color:data.markColor,is_goal:data.isGoal,note:data.note||null},{onConflict:'user_id, entry_date'})}
    else{await sb.from('calendar_app_entries').delete().eq('user_id',UID).eq('entry_date',modalKey)}
    if(data.diary){await sb.from('calendar_app_diary').upsert({user_id:UID,entry_date:modalKey,content:data.diary},{onConflict:'user_id, entry_date'})}
    else{await sb.from('calendar_app_diary').delete().eq('user_id',UID).eq('entry_date',modalKey)}
  }catch(err){console.error('Save:',err)}
}

document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal()});

/* BOOT */
document.addEventListener('DOMContentLoaded',async()=>{
  applyTheme(activeTheme());
  try{await loadThemePref()}catch(e){}
  applyTheme(activeTheme());
  await loadAndRender();
});
</script>
</body>
</html>
